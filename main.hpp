// (c) 2017-2021 Pttn and contributors (https://github.com/Pttn/rieMiner)

#ifndef HEADER_main_hpp
#define HEADER_main_hpp

#include <algorithm>
#include <array>
#include <chrono>
#include <fstream>
#include <iomanip>
#include <mutex>
#include <string>
#include <thread>
#include <unistd.h>
#include <vector>
#include "tools.hpp"

#define versionString	"rieMiner 0.92d"
#define primeTableFile	"PrimeTable64.bin"

extern int DEBUG;
extern std::string confPath;

#define DBG(x) if (DEBUG) {x;};
#define DBG_VERIFY(x) if (DEBUG > 1) { x; };
#define ERRORMSG(message) std::cerr << __func__ << ": " << message << " :| !" << std::endl

static const std::vector<std::pair<std::vector<uint64_t>, std::vector<uint64_t>>> defaultConstellationData = {
	// 1-tuples
	{{0}, {380284918609481ULL, 437163765888581ULL, 701889794782061ULL, 980125031081081ULL, 1277156391416021ULL, 1487854607298791ULL, 1833994713165731ULL, 2115067287743141ULL, 2325810733931801ULL, 3056805353932061ULL, 3252606350489381ULL, 3360877662097841ULL, 3501482688249431ULL, 3595802556731501ULL, 3843547642594391ULL, 5000014653723821ULL}}, // OEIS A213645 (12-tuples)
	// 2-tuples
	{{0, 2}, {380284918609481ULL, 437163765888581ULL, 701889794782061ULL, 980125031081081ULL, 1277156391416021ULL, 1487854607298791ULL, 1833994713165731ULL, 2115067287743141ULL, 2325810733931801ULL, 3056805353932061ULL, 3252606350489381ULL, 3360877662097841ULL, 3501482688249431ULL, 3595802556731501ULL, 3843547642594391ULL, 5000014653723821ULL}}, // OEIS A213645 (12-tuples)
	// 3-tuples
	{{0, 2, 4}, {380284918609481ULL, 437163765888581ULL, 701889794782061ULL, 980125031081081ULL, 1277156391416021ULL, 1487854607298791ULL, 1833994713165731ULL, 2115067287743141ULL, 2325810733931801ULL, 3056805353932061ULL, 3252606350489381ULL, 3360877662097841ULL, 3501482688249431ULL, 3595802556731501ULL, 3843547642594391ULL, 5000014653723821ULL}}, // OEIS A213645 (12-tuples)
	{{0, 4, 2}, {1418575498573ULL, 2118274828903ULL, 4396774576273ULL, 6368171154193ULL, 6953798916913ULL, 27899359258003ULL, 28138953913303ULL, 34460918582323ULL, 40362095929003ULL, 42023308245613ULL, 44058461657443ULL, 61062361183903ULL, 76075560855373ULL, 80114623697803ULL, 84510447435493ULL, 85160397055813ULL}}, // OEIS A213646 (11-tuples)
	// 4-tuples
	{{0, 2, 4, 2}, {380284918609481ULL, 437163765888581ULL, 701889794782061ULL, 980125031081081ULL, 1277156391416021ULL, 1487854607298791ULL, 1833994713165731ULL, 2115067287743141ULL, 2325810733931801ULL, 3056805353932061ULL, 3252606350489381ULL, 3360877662097841ULL, 3501482688249431ULL, 3595802556731501ULL, 3843547642594391ULL, 5000014653723821ULL}}, // OEIS A213646 (12-tuples)
	// 5-tuples
	{{0, 2, 4, 2, 4}, {380284918609481ULL, 437163765888581ULL, 701889794782061ULL, 980125031081081ULL, 1277156391416021ULL, 1487854607298791ULL, 1833994713165731ULL, 2115067287743141ULL, 2325810733931801ULL, 3056805353932061ULL, 3252606350489381ULL, 3360877662097841ULL, 3501482688249431ULL, 3595802556731501ULL, 3843547642594391ULL, 5000014653723821ULL}}, // OEIS A213645 (12-tuples)
	{{0, 4, 2, 4, 2}, {1091257ULL, 1615837ULL, 1954357ULL, 2822707ULL, 2839927ULL, 3243337ULL, 3400207ULL, 6005887ULL, 6503587ULL, 7187767ULL, 7641367ULL, 8061997ULL, 8741137ULL, 10526557ULL, 11086837ULL, 11664547ULL}}, // OEIS A022013 (6-tuples)
	// 6-tuples
	{{0, 4, 2, 4, 2, 4}, {1091257ULL, 1615837ULL, 1954357ULL, 2822707ULL, 2839927ULL, 3243337ULL, 3400207ULL, 6005887ULL, 6503587ULL, 7187767ULL, 7641367ULL, 8061997ULL, 8741137ULL, 10526557ULL, 11086837ULL, 11664547ULL}}, // OEIS A022013
	// 7-tuples
	{{0, 2, 4, 2, 4, 6, 2}, {182403491ULL, 226449521ULL, 910935911ULL, 1042090781ULL, 1459270271ULL, 2843348351ULL, 6394117181ULL, 6765896981ULL, 8247812381ULL, 8750853101ULL, 11076719651ULL, 12850665671ULL, 17140322651ULL, 22784826131ULL, 24816950771ULL, 33081664151ULL, 41614070411ULL, 43298074271ULL, 43813839521ULL, 53001578081ULL, 54270148391ULL, 57440594201ULL, 64202502431ULL, 66449431661ULL, 80587471031ULL, 83122625471ULL, 84882447101ULL, 93288681371ULL, 98257943081ULL, 101698684931ULL, 117762315941ULL, 121317512201ULL, 139017478331ULL, 148323246341ULL, 165952761041ULL, 169349651741ULL, 173405293331ULL, 180237252311ULL, 185814366581ULL, 187735172741ULL, 201708760061ULL, 203499800501ULL, 231965242121ULL, 232942479221ULL, 238333854371ULL, 250319013011ULL, 260208736631ULL, 276512899961ULL, 294757438511ULL, 294920291201ULL, 297532090391ULL, 311094184391ULL, 312962494961ULL, 319751660141ULL, 356380654361ULL, 362110374161ULL, 383960791211ULL, 447073236341ULL, 458958087431ULL, 467061716111ULL, 480327521741ULL, 486294251741ULL, 490609410281ULL, 524512766621ULL}}, // OEIS A022545 (9-tuples)
	{{0, 2, 6, 4, 2, 4, 2}, {855719ULL, 1146779ULL, 6560999ULL, 7540439ULL, 8573429ULL, 17843459ULL, 19089599ULL, 24001709ULL, 42981929ULL, 43534019ULL, 69156539ULL, 74266259ULL, 79208399ULL, 80427029ULL, 84104549ULL, 87988709ULL, 124066079ULL, 128469149ULL, 144214319ULL, 157131419ULL, 208729049ULL, 218033729ULL, 248205689ULL, 261672779ULL, 275105639ULL, 283075139ULL, 284488649ULL, 302542769ULL, 310335659ULL, 327595979ULL, 361289429ULL, 402301169ULL, 417814079ULL, 423380129ULL, 463206839ULL, 501672539ULL, 522911099ULL, 615095849ULL, 626708219ULL, 636375989ULL, 706620359ULL, 832143449ULL, 847812599ULL, 897778949ULL, 964669619ULL, 1052047679ULL, 1076807099ULL, 1094752649ULL, 1103407169ULL, 1110364889ULL, 1119976379ULL, 1128715319ULL, 1141157189ULL, 1148881619ULL, 1163372459ULL, 1170073349ULL, 1182850379ULL, 1294547699ULL, 1300045919ULL, 1340301869ULL, 1340805449ULL, 1377315209ULL, 1400533229ULL, 1422475919ULL}}, // OEIS A022010
	// 8-tuples
	{{0, 2, 4, 2, 4, 6, 2, 6}, {182403491ULL, 226449521ULL, 910935911ULL, 1042090781ULL, 1459270271ULL, 2843348351ULL, 6394117181ULL, 6765896981ULL, 8247812381ULL, 8750853101ULL, 11076719651ULL, 12850665671ULL, 17140322651ULL, 22784826131ULL, 24816950771ULL, 33081664151ULL, 41614070411ULL, 43298074271ULL, 43813839521ULL, 53001578081ULL, 54270148391ULL, 57440594201ULL, 64202502431ULL, 66449431661ULL, 80587471031ULL, 83122625471ULL, 84882447101ULL, 93288681371ULL, 98257943081ULL, 101698684931ULL, 117762315941ULL, 121317512201ULL, 139017478331ULL, 148323246341ULL, 165952761041ULL, 169349651741ULL, 173405293331ULL, 180237252311ULL, 185814366581ULL, 187735172741ULL, 201708760061ULL, 203499800501ULL, 231965242121ULL, 232942479221ULL, 238333854371ULL, 250319013011ULL, 260208736631ULL, 276512899961ULL, 294757438511ULL, 294920291201ULL, 297532090391ULL, 311094184391ULL, 312962494961ULL, 319751660141ULL, 356380654361ULL, 362110374161ULL, 383960791211ULL, 447073236341ULL, 458958087431ULL, 467061716111ULL, 480327521741ULL, 486294251741ULL, 490609410281ULL, 524512766621ULL}}, // OEIS A022545 (9-tuples)
	{{0, 2, 4, 6, 2, 6, 4, 2}, {252277007ULL, 408936947ULL, 521481197ULL, 1116452627ULL, 1209950867ULL, 1645175087ULL, 2966003057ULL, 3947480417ULL, 6234613727ULL, 9307040837ULL, 9853497737ULL, 11878692167ULL, 13766391467ULL, 21956291867ULL, 22741837817ULL, 24388061207ULL, 24718113437ULL, 28498194707ULL, 29177275067ULL, 31201358387ULL, 32417170127ULL, 36230354177ULL, 42052236197ULL, 51435506387ULL, 54202818407ULL, 58797275477ULL, 65366478887ULL, 67406579477ULL, 71999669297ULL, 78270669767ULL, 78271296197ULL, 80187554327ULL, 83026673747ULL, 83115690167ULL, 94968471107ULL, 98793034577ULL, 99409572527ULL, 103798521707ULL, 105035735657ULL, 107735906477ULL, 110559120797ULL, 115154953997ULL, 119187533807ULL, 121801892477ULL, 127788668717ULL, 130714028567ULL, 133021481687ULL, 138733641017ULL, 143977593497ULL, 144011113217ULL, 149414528357ULL, 150684085817ULL, 153039812897ULL, 158532152477ULL, 164444511587ULL, 168478035617ULL, 172660174847ULL, 179142250577ULL, 179590045487ULL, 180566297267ULL, 181503415127ULL, 183562654127ULL, 185242953017ULL, 187505538587ULL}}, // OEIS A022546 (9-tuples)
	{{0, 6, 2, 6, 4, 2, 4, 2}, {855713ULL, 1146773ULL, 6560993ULL, 69156533ULL, 74266253ULL, 218033723ULL, 261672773ULL, 302542763ULL, 964669613ULL, 1340301863ULL, 1400533223ULL, 1422475913ULL, 1837160183ULL, 1962038783ULL, 2117861723ULL, 2249363093ULL, 2272018733ULL, 2558211563ULL, 2688926483ULL, 2873599433ULL, 2949262223ULL, 3279413303ULL, 4038726053ULL, 4367051393ULL, 4412997293ULL, 5266022123ULL, 5536960133ULL, 5766036953ULL, 5872387883ULL, 6160962323ULL, 6568530953ULL, 6643729223ULL, 7380381713ULL, 8076004613ULL, 8793321983ULL, 8878545653ULL, 9014360213ULL, 9853497743ULL, 9894091373ULL, 10208565533ULL, 10352635193ULL, 10375379453ULL, 11163865613ULL, 13098746183ULL, 14253395063ULL, 15605935973ULL, 15608334803ULL, 15823140233ULL, 16394542253ULL, 16760183963ULL, 17236012883ULL, 18873493343ULL, 20405586563ULL, 21148325903ULL, 21171795083ULL, 21199560443ULL, 21583850993ULL, 21895250543ULL, 21956291873ULL, 22185482303ULL, 22251770063ULL, 22741837823ULL, 22853737583ULL, 22999547933ULL}}, // OEIS A022013
	// 9-tuples
	{{0, 2, 4, 2, 4, 6, 2, 6, 4}, {182403491ULL, 226449521ULL, 910935911ULL, 1042090781ULL, 1459270271ULL, 2843348351ULL, 6394117181ULL, 6765896981ULL, 8247812381ULL, 8750853101ULL, 11076719651ULL, 12850665671ULL, 17140322651ULL, 22784826131ULL, 24816950771ULL, 33081664151ULL, 41614070411ULL, 43298074271ULL, 43813839521ULL, 53001578081ULL, 54270148391ULL, 57440594201ULL, 64202502431ULL, 66449431661ULL, 80587471031ULL, 83122625471ULL, 84882447101ULL, 93288681371ULL, 98257943081ULL, 101698684931ULL, 117762315941ULL, 121317512201ULL, 139017478331ULL, 148323246341ULL, 165952761041ULL, 169349651741ULL, 173405293331ULL, 180237252311ULL, 185814366581ULL, 187735172741ULL, 201708760061ULL, 203499800501ULL, 231965242121ULL, 232942479221ULL, 238333854371ULL, 250319013011ULL, 260208736631ULL, 276512899961ULL, 294757438511ULL, 294920291201ULL, 297532090391ULL, 311094184391ULL, 312962494961ULL, 319751660141ULL, 356380654361ULL, 362110374161ULL, 383960791211ULL, 447073236341ULL, 458958087431ULL, 467061716111ULL, 480327521741ULL, 486294251741ULL, 490609410281ULL, 524512766621ULL}}, // OEIS A022545
	{{0, 2, 4, 6, 2, 6, 4, 2, 4}, {252277007ULL, 408936947ULL, 521481197ULL, 1116452627ULL, 1209950867ULL, 1645175087ULL, 2966003057ULL, 3947480417ULL, 6234613727ULL, 9307040837ULL, 9853497737ULL, 11878692167ULL, 13766391467ULL, 21956291867ULL, 22741837817ULL, 24388061207ULL, 24718113437ULL, 28498194707ULL, 29177275067ULL, 31201358387ULL, 32417170127ULL, 36230354177ULL, 42052236197ULL, 51435506387ULL, 54202818407ULL, 58797275477ULL, 65366478887ULL, 67406579477ULL, 71999669297ULL, 78270669767ULL, 78271296197ULL, 80187554327ULL, 83026673747ULL, 83115690167ULL, 94968471107ULL, 98793034577ULL, 99409572527ULL, 103798521707ULL, 105035735657ULL, 107735906477ULL, 110559120797ULL, 115154953997ULL, 119187533807ULL, 121801892477ULL, 127788668717ULL, 130714028567ULL, 133021481687ULL, 138733641017ULL, 143977593497ULL, 144011113217ULL, 149414528357ULL, 150684085817ULL, 153039812897ULL, 158532152477ULL, 164444511587ULL, 168478035617ULL, 172660174847ULL, 179142250577ULL, 179590045487ULL, 180566297267ULL, 181503415127ULL, 183562654127ULL, 185242953017ULL, 187505538587ULL}}, // OEIS A022546
	{{0, 4, 2, 4, 6, 2, 6, 4, 2}, {626927443ULL, 2335215973ULL, 3447123283ULL, 4086982633ULL, 4422726013ULL, 6318867403ULL, 7093284043ULL, 8541306853ULL, 10998082213ULL, 14005112893ULL, 18869466373ULL, 21528117883ULL, 21843411823ULL, 28156779793ULL, 30303283243ULL, 31194463033ULL, 33081664153ULL, 35004115033ULL, 35193551203ULL, 39682755793ULL, 41666557393ULL, 47064359803ULL, 47798406193ULL, 49533488083ULL, 51435506383ULL, 52719078673ULL, 57366516913ULL, 59038943053ULL, 59780979103ULL, 62564104063ULL, 75832757233ULL, 79963083433ULL, 83122625473ULL, 93138486583ULL, 93789236683ULL, 96259498873ULL, 97966866703ULL, 99409572523ULL, 103050287293ULL, 103798521703ULL, 104751695743ULL, 106211658583ULL, 107961509413ULL, 109055504263ULL, 114829973953ULL, 115316796583ULL, 118423267423ULL, 118934479663ULL, 122015998183ULL, 124684085413ULL, 131971411123ULL, 135936506593ULL, 137064385303ULL, 140163144673ULL, 142641528763ULL, 143449458613ULL, 151411248403ULL, 154176423673ULL, 157797433873ULL, 158114143063ULL, 163680506593ULL, 168478035613ULL, 175029719713ULL, 175956805873ULL}}, // OEIS A022547
	{{0, 4, 6, 2, 6, 4, 2, 4, 2}, {855709ULL, 74266249ULL, 964669609ULL, 1422475909ULL, 2117861719ULL, 2558211559ULL, 2873599429ULL, 5766036949ULL, 6568530949ULL, 8076004609ULL, 9853497739ULL, 16394542249ULL, 21171795079ULL, 21956291869ULL, 22741837819ULL, 26486447149ULL, 27254489389ULL, 36955907689ULL, 37045175329ULL, 39745733539ULL, 71369039869ULL, 75884569279ULL, 87554295529ULL, 88431318949ULL, 108039383509ULL, 120739615669ULL, 123878599699ULL, 141741265639ULL, 146163774919ULL, 164444511589ULL, 177313452289ULL, 179590045489ULL, 181523196289ULL, 185222773639ULL, 187996202479ULL, 188506859059ULL, 193993844899ULL, 194000607319ULL, 196253905009ULL, 199998949669ULL, 216887683069ULL, 217999764109ULL, 219795770629ULL, 231255798859ULL, 242360943259ULL, 260222396869ULL, 267204456499ULL, 292624431079ULL, 293320920019ULL, 303023883289ULL, 330293107579ULL, 341741739319ULL, 355111401499ULL, 360744936679ULL, 385736835919ULL, 413801829799ULL, 437984753179ULL, 448301185459ULL, 463152187009ULL, 465328692529ULL, 478863103699ULL, 489963274039ULL, 533840361139ULL, 557552371279ULL}}, // OEIS A022548
	// 10-tuples
	{{0, 2, 4, 2, 4, 6, 2, 6, 4, 2}, {380284918609481ULL, 437163765888581ULL, 701889794782061ULL, 980125031081081ULL, 1277156391416021ULL, 1487854607298791ULL, 1833994713165731ULL, 2115067287743141ULL, 2325810733931801ULL, 3056805353932061ULL, 3252606350489381ULL, 3360877662097841ULL, 3501482688249431ULL, 3595802556731501ULL, 3843547642594391ULL, 5000014653723821ULL}}, // OEIS A213645 (12-tuples)
	{{0, 2, 4, 6, 2, 6, 4, 2, 4, 2}, {9853497737ULL, 21956291867ULL, 22741837817ULL, 164444511587ULL, 179590045487ULL, 217999764107ULL, 231255798857ULL, 242360943257ULL, 666413245007ULL, 696391309697ULL, 867132039857ULL, 974275568237ULL, 976136848847ULL, 1002263588297ULL, 1086344116367ULL, 1403337211247ULL}}, // OEIS A027570
	// 11-tuples
	{{0, 2, 4, 2, 4, 6, 2, 6, 4, 2, 4}, {380284918609481ULL, 437163765888581ULL, 701889794782061ULL, 980125031081081ULL, 1277156391416021ULL, 1487854607298791ULL, 1833994713165731ULL, 2115067287743141ULL, 2325810733931801ULL, 3056805353932061ULL, 3252606350489381ULL, 3360877662097841ULL, 3501482688249431ULL, 3595802556731501ULL, 3843547642594391ULL, 5000014653723821ULL}}, // OEIS A213645 (12-tuples)
	{{0, 4, 2, 4, 6, 2, 6, 4, 2, 4, 2}, {1418575498573ULL, 2118274828903ULL, 4396774576273ULL, 6368171154193ULL, 6953798916913ULL, 27899359258003ULL, 28138953913303ULL, 34460918582323ULL, 40362095929003ULL, 42023308245613ULL, 44058461657443ULL, 61062361183903ULL, 76075560855373ULL, 80114623697803ULL, 84510447435493ULL, 85160397055813ULL}}, // OEIS A213646
	// 12-tuples
	{{0, 2, 4, 2, 4, 6, 2, 6, 4, 2, 4, 6}, {380284918609481ULL, 437163765888581ULL, 701889794782061ULL, 980125031081081ULL, 1277156391416021ULL, 1487854607298791ULL, 1833994713165731ULL, 2115067287743141ULL, 2325810733931801ULL, 3056805353932061ULL, 3252606350489381ULL, 3360877662097841ULL, 3501482688249431ULL, 3595802556731501ULL, 3843547642594391ULL, 5000014653723821ULL}}, // OEIS A213645
	{{0, 6, 4, 2, 4, 6, 2, 6, 4, 2, 4, 2}, {1418575498567ULL, 27899359257997ULL, 34460918582317ULL, 76075560855367ULL, 186460616596327ULL, 218021188549237ULL, 234280497145537ULL, 282854319391717ULL, 345120905374087ULL, 346117552180627ULL, 604439135284057ULL, 727417501795057ULL, 1041814617748747ULL, 1090754719898917ULL, 1539765965257747ULL, 3152045700948217ULL}} // OEIS A213601
};

struct MinerParameters {
	uint16_t threads, sieveWorkers, tupleLengthMin;
	uint64_t primorialNumber, primeTableLimit;
	bool useAvx2;
	uint64_t sieveBits, sieveSize, sieveWords, sieveIterations;
	std::vector<uint64_t> pattern, primorialOffsets;
	double restartDifficultyFactor;
	
	MinerParameters() :
		threads(0), sieveWorkers(0), tupleLengthMin(0),
		primorialNumber(0), primeTableLimit(0),
		useAvx2(false),
		sieveBits(0), sieveSize(0), sieveWords(0), sieveIterations(0),
		pattern{}, primorialOffsets{},
		restartDifficultyFactor(1.05) {}
};

class Options {
	MinerParameters _minerParameters;
	std::string _host, _username, _password, _mode, _payoutAddress, _secret, _tuplesFile;
	uint64_t _filePrimeTableLimit;
	uint16_t _debug, _port, _threads, _donate;
	double _refreshInterval, _difficulty, _benchmarkBlockInterval, _benchmarkTimeLimit;
	uint64_t _benchmarkPrimeCountLimit;
	std::vector<std::string> _rules;
	std::vector<std::string> _options;
	
	void _parseLine(std::string, std::string&, std::string&) const;
	void _stopConfig() const;
	
	public:
	Options() : // Default options: Standard Benchmark with 8 threads
		_host("127.0.0.1"),
		_username(""),
		_password(""),
		_mode("Benchmark"),
		_payoutAddress("ric1qr3yxckxtl7lacvtuzhrdrtrlzvlydane2h37ja"),
		_secret("/rM0.92/"),
		_tuplesFile("Tuples.txt"),
		_filePrimeTableLimit(0),
		_debug(0),
		_port(28332),
		_donate(2),
		_refreshInterval(30.),
		_difficulty(1024.),
		_benchmarkBlockInterval(150.),
		_benchmarkTimeLimit(86400.),
		_benchmarkPrimeCountLimit(1000000),
		_rules{"segwit"},
		_options{} {}
	
	void loadFileOptions(const std::string&, const bool);
	void loadCommandOptions(const int, char**);
	void parseOptions();
	
	MinerParameters minerParameters() const {return _minerParameters;}
	std::string mode() const {return _mode;}
	std::string host() const {return _host;}
	uint16_t port() const {return _port;}
	std::string username() const {return _username;}
	std::string password() const {return _password;}
	std::string payoutAddress() const {return _payoutAddress;}
	std::string secret() const {return _secret;}
	std::string tuplesFile() const {return _tuplesFile;}
	uint64_t filePrimeTableLimit() const {return _filePrimeTableLimit;}
	uint16_t donate() const {return _donate;}
	double refreshInterval() const {return _refreshInterval;}
	double difficulty() const {return _difficulty;}
	double benchmarkBlockInterval() const {return _benchmarkBlockInterval;}
	double benchmarkTimeLimit() const {return _benchmarkTimeLimit;}
	uint64_t benchmarkPrimeCountLimit() const {return _benchmarkPrimeCountLimit;}
	std::vector<std::string> rules() const {return _rules;}
};

#endif
